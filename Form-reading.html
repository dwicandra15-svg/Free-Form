<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Form-reading-FINAL</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap');
    :root{
      --card-bg: rgba(255,255,255,0.96);
    }
    html,body{height:100%}
    body{font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; background: linear-gradient(90deg,#3b82f6 0%,#8b5cf6 50%,#ec4899 100%); }
    .container{max-width:980px;margin:36px auto;padding:28px;}
    .card{background:var(--card-bg);border-radius:18px;padding:34px;box-shadow:0 12px 30px rgba(2,6,23,0.2);border:1px solid rgba(13,42,148,0.06)}
    .input{width:100%;padding:16px;border-radius:12px;border:2px solid rgba(0,0,0,0.06);font-size:16px}
    .label{font-weight:700;color:#1f2937;margin-bottom:8px;display:flex;gap:8px;align-items:center}
    .note{background:#fffbeb;border:1px solid #fde68a;padding:12px;border-radius:10px;color:#92400e}
    .big-btn{width:100%;padding:16px;border-radius:12px;font-weight:800;background:linear-gradient(90deg,#3b82f6,#8b5cf6);color:white;border:none;box-shadow:0 8px 20px rgba(99,102,241,0.24)}
    .small-btn{padding:10px 12px;border-radius:10px;font-weight:700;border:none}
    .admin-dot{position:absolute;right:28px;top:24px;background:rgba(59,130,246,0.95);width:44px;height:44px;border-radius:10px;color:white;display:flex;align-items:center;justify-content:center;font-size:22px;cursor:pointer;box-shadow:0 6px 18px rgba(59,130,246,0.22)}
    .muted {color:#6b7280}
    @media (max-width:720px){
      .container{margin:18px;padding:16px}
      .card{padding:20px;border-radius:14px}
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="card relative">
      <div class="admin-dot" title="Admin menu" onclick="openAdmin()">â‹®</div>
      <div style="text-align:center;margin-bottom:8px">
        <div style="font-size:44px;margin-bottom:6px">ğŸ“š</div>
        <h1 style="font-size:34px;margin:6px 0;font-weight:800;color:#0f172a">English Reading Assessment</h1>
        <p class="muted" id="chapterUnitDisplay">Chapter 2: Taking Trips - Unit 2: What an Experience</p>
      </div>

      <div id="appContent">
        <!-- initial form rendered by JS -->
      </div>
    </div>
  </div>

<script>
/* ========= State & Config =========== */
const ADMIN_USERNAME = 'Unknown';
const ADMIN_PASSWORD = '123456';
const STORAGE_KEY = 'reading_missions_v1';

let state = {
  studentName:'', studentClass:'', selectedLevel:'', showForm:true,
  currentMission:0, missionScores:[], showFinalScore:false,
  isSpeaking:false, isRecording:false, transcript:'', showResult:false,
  recognition:null, errorMessage:'',
  showAdminLogin:false, showAdminMenu:false, adminView:null, isAdmin:false,
  adminUser:'', adminPass:'', adminSelectedLevel:'beginner', adminNewSentence:'',
  adminEditIndex:null, adminEditValue:'',
  currentChapter:'Chapter 2: Taking Trips', currentUnit:'Unit 2: What an Experience'
};

const defaultMissions = {
  beginner:[
"I love to travel and see new places","The beach is very beautiful today","We visited a wonderful museum yesterday",
"My family enjoys camping in the mountains","The hotel room has a nice view","I like to take pictures of nature",
"Traveling makes me very happy"
  ],
  intermediate:[
"I had an amazing experience during my trip to Bali","The view from the mountain top was absolutely breathtaking",
"We explored ancient temples and learned about local culture","Swimming in the crystal clear water was unforgettable",
"The traditional dance performance was truly spectacular","Meeting friendly locals made our journey more meaningful",
"This vacation created wonderful memories that will last forever"
  ],
  advanced:[
"Embarking on this extraordinary adventure provided invaluable insights into diverse cultures",
"The magnificent landscape encompassed towering peaks and pristine valleys below",
"Our expedition through historical landmarks revealed fascinating architectural achievements",
"Experiencing authentic cuisine while interacting with indigenous communities was remarkable",
"The mesmerizing performance showcased centuries-old traditions passed through generations",
"Establishing connections with welcoming inhabitants enriched our understanding significantly",
"This remarkable journey profoundly transformed our perspectives on global diversity"
  ],
  expert:[
"Traversing through this unprecedented expedition yielded profound comprehension of multifaceted civilizations",
"The awe-inspiring topography encompassed monumental summits and immaculate geological formations",
"Our archaeological investigation unveiled extraordinary testimonials of sophisticated engineering methodologies",
"Encountering gastronomic authenticity whilst engaging with aboriginal populations proved extraordinarily enlightening",
"The captivating theatrical presentation exemplified antiquated customs meticulously preserved across millennia",
"Cultivating meaningful rapport with hospitable denizens substantially augmented our anthropological cognizance",
"This transformative odyssey fundamentally revolutionized our philosophical paradigms regarding intercultural dynamics"
  ]
};

function loadMissions(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw) return JSON.parse(JSON.stringify(defaultMissions));
    const parsed = JSON.parse(raw);
    for(const k of ['beginner','intermediate','advanced','expert']){
      if(!Array.isArray(parsed[k])) parsed[k]=[...defaultMissions[k]];
    }
    return parsed;
  }catch(e){
    return JSON.parse(JSON.stringify(defaultMissions));
  }
}
function saveMissions(m){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(m));
}
let missionsByLevel = loadMissions();

const scoringThresholds = { beginner:{excellent:70,good:50,enough:30}, intermediate:{excellent:80,good:60,enough:35}, advanced:{excellent:88,good:68,enough:42}, expert:{excellent:95,good:75,enough:50} };

/* ===== Speech recognition helpers ===== */
function initializeSpeechRecognition(){
  if(!('webkitSpeechRecognition' in window || 'SpeechRecognition' in window)){
    state.errorMessage='âŒ Browser tidak mendukung Speech Recognition (pakai Chrome)';
    render();
    return false;
  }
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  const recognition = new SpeechRecognition();
  recognition.continuous = false;
  recognition.interimResults = false;
  recognition.lang = 'en-US';
  recognition.maxAlternatives = 1;
  recognition.onstart = ()=>{ state.isRecording=true; state.errorMessage=''; render(); };
  recognition.onresult = (e)=>{ state.transcript = e.results[0][0].transcript; state.isRecording=false; render(); };
  recognition.onerror = (e)=>{ state.isRecording=false; state.errorMessage = 'âš ï¸ '+(e.error||'error'); render(); };
  recognition.onend = ()=>{ state.isRecording=false; render(); };
  state.recognition = recognition;
  return true;
}

async function testMicrophone(){
  try{
    const s = await navigator.mediaDevices.getUserMedia({audio:true});
    s.getTracks().forEach(t=>t.stop());
    state.errorMessage='âœ… Microphone OK!';
    alert('âœ… Microphone berhasil diakses!');
    render();
  }catch(e){
    state.errorMessage='âŒ Microphone tidak diizinkan!';
    alert('âŒ Microphone tidak diizinkan. Periksa permissions.');
    render();
  }
}

/* ===== Assessment logic ===== */
function handleStartAssessment(){
  const name = document.getElementById('studentName').value.trim();
  const cls = document.getElementById('studentClass').value.trim();
  const level = document.getElementById('levelSelect').value;
  if(!name||!cls||!level){ alert('Isi Nama, Kelas, dan Level terlebih dahulu'); return; }
  state.studentName=name; state.studentClass=cls; state.selectedLevel=level; state.showForm=false;
  state.missionScores = Array(missionsByLevel[level].length).fill(null);
  initializeSpeechRecognition();
  render();
}

function speakText(){
  try{
    window.speechSynthesis.cancel();
    const text = missionsByLevel[state.selectedLevel][state.currentMission];
    const u = new SpeechSynthesisUtterance(text);
    u.lang='en-US'; u.rate=0.6;
    u.onstart=()=>{ state.isSpeaking=true; render(); };
    u.onend=()=>{ state.isSpeaking=false; render(); };
    window.speechSynthesis.speak(u);
  }catch(e){ console.warn(e); }
}

function handleJudge(){
  if(!state.recognition){ alert('Speech recognition belum tersedia. Pastikan pakai Chrome.'); return; }
  state.transcript=''; state.showResult=false; state.errorMessage='';
  try{ state.recognition.start(); } catch(e){ console.warn(e); state.errorMessage='âš ï¸ Gagal mulai recording'; render(); }
}

function calculateScore(original, spoken, level){
  if(!spoken) return 'Bad';
  const norm = t=> t.toLowerCase().replace(/[.,!?;'"()]/g,'').replace(/\s+/g,' ').trim();
  const o = norm(original).split(' '); const s = norm(spoken).split(' ');
  let match = 0; o.forEach(w=>{ if(s.includes(w)) match++; });
  const acc = (match / o.length)*100;
  const th = scoringThresholds[level];
  if(acc >= th.excellent) return 'Excellent';
  if(acc >= th.good) return 'Good';
  if(acc >= th.enough) return 'Enough';
  return 'Bad';
}

function handleResult(){
  if(!state.transcript){ alert('Belum ada rekaman. Klik JUDGE lalu bicara.'); return; }
  const missions = missionsByLevel[state.selectedLevel];
  const score = calculateScore(missions[state.currentMission], state.transcript, state.selectedLevel);
  state.missionScores[state.currentMission]=score;
  state.showResult=true;
  render();
}

function handleNext(){
  if(!state.missionScores[state.currentMission]){ alert('Klik RESULT dulu untuk nilai'); return; }
  const total = missionsByLevel[state.selectedLevel].length;
  if(state.currentMission < total-1){
    state.currentMission++; state.transcript=''; state.showResult=false;
  } else {
    state.showFinalScore=true;
  }
  render();
}

function calculateFinalScore(){
  const vals = {Excellent:100,Good:75,Enough:50,Bad:25};
  const total = state.missionScores.length || 1;
  const sum = state.missionScores.reduce((a,b)=> a + (vals[b]||0), 0);
  return Math.round(sum/total);
}
function getFinalGrade(avg){
  if(avg>=85) return 'Excellent';
  if(avg>=65) return 'Good';
  if(avg>=40) return 'Enough';
  return 'Bad';
}

/* ===== Admin functions ===== */
function openAdmin(){ state.showAdminLogin=true; state.showAdminMenu=false; state.adminView=null; render(); }
function closeAdminAll(){ state.showAdminLogin=false; state.showAdminMenu=false; state.adminView=null; state.isAdmin=false; state.adminUser=''; state.adminPass=''; state.adminNewSentence=''; state.adminEditIndex=null; state.adminEditValue=''; render(); }
function handleAdminLogin(){
  if(state.adminUser===ADMIN_USERNAME && state.adminPass===ADMIN_PASSWORD){
    state.isAdmin=true; state.showAdminLogin=false; state.showAdminMenu=true; state.adminView='menu';
  } else { alert('Username atau password salah'); }
  render();
}
function gotoAdminMenu(){ state.showAdminMenu=true; state.adminView='menu'; render(); }
function gotoAdd(){ state.adminView='add'; render(); }
function gotoChange(){ state.adminView='change'; render(); }
function gotoChangeChapterUnit(){ state.adminView='chapterUnit'; render(); }
function adminLogout(){ closeAdminAll(); }

function adminAddMaterial(){
  const txt = (state.adminNewSentence||'').trim();
  if(!txt){ alert('Kalimat kosong'); return; }
  missionsByLevel[state.adminSelectedLevel].push(txt);
  saveMissions(missionsByLevel);
  state.adminNewSentence='';
  alert('âœ… Materi ditambahkan');
  render();
}

function adminDeleteMaterial(level, index){
  if(!confirm('Hapus materi ini?')) return;
  missionsByLevel[level].splice(index,1);
  saveMissions(missionsByLevel);
  if(!state.showForm && state.selectedLevel===level){
    const total = missionsByLevel[level].length;
    state.missionScores = state.missionScores.slice(0,total);
    if(state.currentMission>=total) state.currentMission = Math.max(0,total-1);
  }
  render();
}

function startEditMaterial(level, index){
  state.adminEditIndex = index; state.adminEditValue = missionsByLevel[level][index]; render();
}
function cancelEditMaterial(){ state.adminEditIndex = null; state.adminEditValue=''; render(); }
function saveEditMaterial(level, index){
  const txt = (state.adminEditValue||'').trim(); if(!txt){ alert('Kalimat kosong'); return; }
  missionsByLevel[level][index] = txt; saveMissions(missionsByLevel); state.adminEditIndex=null; state.adminEditValue=''; alert('âœ… Materi diperbarui'); render();
}

function saveChapterUnit(){
  localStorage.setItem('chapter_unit_settings_v1', JSON.stringify({ chapter: state.currentChapter, unit: state.currentUnit }));
  document.getElementById('chapterUnitDisplay').innerText = state.currentChapter + ' - ' + state.currentUnit;
  alert('âœ… Chapter & Unit disimpan');
  render();
}

/* ===== Rendering ===== */
function render(){
  document.getElementById('chapterUnitDisplay').innerText = state.currentChapter + ' - ' + state.currentUnit;
  const app = document.getElementById('appContent');
  if(state.showForm){
    app.innerHTML = `
      <div>
        <div style="margin-bottom:18px">
          <label class="label"><span style="font-size:18px">ğŸ‘¤</span><span>Student Name / Nama Siswa:</span></label>
          <input id="studentName" class="input" placeholder="Enter your name" />
        </div>
        <div style="margin-bottom:18px">
          <label class="label"><span style="font-size:18px">ğŸ«</span><span>Class / Kelas:</span></label>
          <input id="studentClass" class="input" placeholder="e.g., 7A, 8B, IX-1" />
        </div>
        <div style="margin-bottom:14px">
          <label class="label"><span style="font-size:18px">ğŸ¯</span><span>Difficulty Level / Tingkat Kesulitan:</span></label>
          <select id="levelSelect" class="input" >
            <option value="">-- Select Level --</option>
            <option value="beginner">ğŸŒ± BEGINNER (Easy)</option>
            <option value="intermediate">ğŸŒ¿ INTERMEDIATE (Normal)</option>
            <option value="advanced">ğŸŒ³ ADVANCED (Hard)</option>
            <option value="expert">ğŸ† EXPERT (Very Hard)</option>
          </select>
        </div>
        <div class="note" style="margin-bottom:18px">âš ï¸ <strong>Perhatian:</strong> Semakin tinggi level, semakin susah mendapat nilai Excellent!</div>
        <button class="big-btn" onclick="handleStartAssessment()">ğŸš€ Start Assessment</button>
      </div>
      ${renderAdminOverlaysInline()}
    `;
  } else if(state.showFinalScore){
    const final = calculateFinalScore();
    const grade = getFinalGrade(final);
    app.innerHTML = `
      <div style="text-align:center">
        <h2 style="font-size:24px;font-weight:800">Assessment Complete!</h2>
        <p style="font-size:44px;color:#7c3aed;margin:18px 0">${final}</p>
        <p style="font-weight:700">${grade}</p>
        <div style="margin-top:20px">
          <button class="big-btn" onclick="restartAndReset()">ğŸ”„ Start New Assessment</button>
        </div>
      </div>
    `;
  } else {
    const missions = missionsByLevel[state.selectedLevel];
    const total = missions.length;
    const cur = missions[state.currentMission];
    const currentScore = state.missionScores[state.currentMission];
    app.innerHTML = `
      <div>
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
          <div>
            <div style="font-weight:800;font-size:18px">${state.studentName}</div>
            <div class="muted" style="font-size:13px">${state.studentClass} â€¢ ${getLevelText(state.selectedLevel)}</div>
          </div>
          <div style="text-align:right"><div class="muted">Mission ${state.currentMission+1} / ${total}</div></div>
        </div>
        <div style="background:linear-gradient(90deg,#f8fafc,#eef2ff);padding:18px;border-radius:12px;margin-bottom:12px;border:1px solid rgba(99,102,241,0.08)">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
            <div style="font-weight:700">ğŸ“– Read this:</div>
            <button class="small-btn" onclick="speakText()" style="background:#2563eb;color:white">ğŸ”Š ${state.isSpeaking? 'STOP':'LISTEN'}</button>
          </div>
          <div style="font-size:16px;font-weight:600;color:#0f172a">"${cur}"</div>
        </div>

        ${state.isRecording? '<div style="background:#fff1f2;padding:12px;border-radius:10px;margin-bottom:10px;color:#b91c1c;font-weight:700">ğŸ¤ RECORDING... Speak clearly</div>':''}
        ${state.transcript? `<div style="background:#ecfdf5;padding:12px;border-radius:10px;margin-bottom:10px;color:#065f46"><strong>âœ… Your recording:</strong><div style="margin-top:6px;font-style:italic">"${state.transcript}"</div></div>`:''}
        ${state.showResult && currentScore? `<div style="background:#eef2ff;padding:12px;border-radius:10px;margin-bottom:10px;color:#3730a3;font-weight:800;text-align:center">${currentScore}</div>` : ''}

        <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px">
          <button class="small-btn" onclick="handleJudge()" style="background:#10b981;color:white">JUDGE</button>
          <button class="small-btn" onclick="handleResult()" style="background:#3b82f6;color:white">RESULT</button>
          <button class="small-btn" onclick="handleNext()" style="background:#7c3aed;color:white">${state.currentMission < total-1 ? 'NEXT' : 'FINISH'}</button>
        </div>
      </div>
    `;
  }
}

/* Inline admin overlays renderer (returns HTML string) */
function renderAdminOverlaysInline(){
  if(!state.showAdminLogin && !state.showAdminMenu) return '';
  if(state.showAdminLogin){
    return `
      <div style="position:fixed;inset:0;display:flex;align-items:center;justify-content:center;z-index:80">
        <div style="background:white;padding:18px;border-radius:12px;max-width:380px;width:92%;box-shadow:0 12px 30px rgba(2,6,23,0.18)">
          <h3 style="font-weight:800;margin-bottom:8px">Guru Login</h3>
          <input placeholder="Username" value="${state.adminUser||''}" oninput="state.adminUser=this.value" class="input" style="margin-bottom:8px"/>
          <input type="password" placeholder="Password" value="${state.adminPass||''}" oninput="state.adminPass=this.value" class="input" style="margin-bottom:8px"/>
          <div style="display:flex;gap:8px">
            <button class="big-btn" onclick="handleAdminLogin()">Login</button>
            <button class="small-btn" style="background:#f3f4f6" onclick="closeAdminAll()">Cancel</button>
          </div>
        </div>
      </div>
    `;
  }
  if(state.showAdminMenu){
    let body=''; 
    if(state.adminView==='menu'){
      body = `
        <h3 style="font-weight:800;margin-bottom:10px">Admin Menu</h3>
        <button class="big-btn" onclick="gotoAdd()">â• Add Material</button>
        <button class="big-btn" onclick="gotoChange()" style="margin-top:8px;background:linear-gradient(90deg,#06b6d4,#3b82f6)">âœï¸ Change Material</button>
        <button class="big-btn" onclick="gotoChangeChapterUnit()" style="margin-top:8px;background:linear-gradient(90deg,#7c3aed,#ec4899)">ğŸ”„ Change Chapter & Unit</button>
        <button class="small-btn" style="margin-top:8px;border:1px solid #e5e7eb" onclick="adminLogout()">Logout</button>
      `;
    } else if(state.adminView==='add'){
      body = `
        <h3 style="font-weight:800;margin-bottom:10px">Add Material</h3>
        <label class="label"><span style="font-size:18px">Level</span></label>
        <select onchange="state.adminSelectedLevel=this.value" class="input" style="margin-bottom:8px">
          <option value="beginner">Beginner</option><option value="intermediate">Intermediate</option><option value="advanced">Advanced</option><option value="expert">Expert</option>
        </select>
        <textarea oninput="state.adminNewSentence=this.value" placeholder="Type sentence..." class="input" style="min-height:100px;margin-bottom:8px"></textarea>
        <div style="display:flex;gap:8px">
          <button class="big-btn" onclick="adminAddMaterial()">Save</button>
          <button class="small-btn" style="background:#f3f4f6" onclick="gotoAdminMenu()">Back</button>
        </div>
      `;
    } else if(state.adminView==='chapterUnit'){
      body = `
        <h3 style="font-weight:800;margin-bottom:10px">Change Chapter & Unit</h3>
        <input value="${state.currentChapter}" oninput="state.currentChapter=this.value" class="input" style="margin-bottom:8px"/>
        <input value="${state.currentUnit}" oninput="state.currentUnit=this.value" class="input" style="margin-bottom:8px"/>
        <div style="display:flex;gap:8px">
          <button class="big-btn" onclick="saveChapterUnit()">Save</button>
          <button class="small-btn" style="background:#f3f4f6" onclick="gotoAdminMenu()">Back</button>
        </div>
      `;
    } else if(state.adminView==='change'){
      const level = state.adminSelectedLevel || 'beginner';
      const list = missionsByLevel[level] || [];
      let items = '';
      list.forEach((it,idx)=>{
        if(state.adminEditIndex===idx){
          items += `<div style="border:1px solid #eef2ff;padding:8px;border-radius:8px;margin-bottom:8px">
            <textarea oninput="state.adminEditValue=this.value" class="input" style="min-height:80px">${state.adminEditValue||''}</textarea>
            <div style="display:flex;gap:8px;margin-top:8px">
              <button class="small-btn" style="background:#3b82f6;color:white" onclick="saveEditMaterial('${level}',${idx})">Save</button>
              <button class="small-btn" onclick="cancelEditMaterial()">Cancel</button>
            </div>
          </div>`;
        } else {
          items += `<div style="border:1px solid #f3f4f6;padding:12px;border-radius:8px;margin-bottom:8px">
            <div style="font-size:14px;font-weight:700;margin-bottom:6px">#${idx+1}</div>
            <div style="margin-bottom:8px">${it}</div>
            <div style="display:flex;gap:8px">
              <button class="small-btn" style="background:#06b6d4;color:white" onclick="startEditMaterial('${level}',${idx})">Edit</button>
              <button class="small-btn" style="background:#ef4444;color:white" onclick="adminDeleteMaterial('${level}',${idx})">Delete</button>
            </div>
          </div>`;
        }
      });
      body = `
        <h3 style="font-weight:800;margin-bottom:10px">Change Material</h3>
        <label class="label">Level</label>
        <select onchange="state.adminSelectedLevel=this.value; render();" class="input" style="margin-bottom:12px">
          <option value="beginner" ${level==='beginner'?'selected':''}>Beginner</option>
          <option value="intermediate" ${level==='intermediate'?'selected':''}>Intermediate</option>
          <option value="advanced" ${level==='advanced'?'selected':''}>Advanced</option>
          <option value="expert" ${level==='expert'?'selected':''}>Expert</option>
        </select>
        <div style="max-height:50vh;overflow:auto;padding-right:6px">${items}</div>
        <div style="margin-top:8px;display:flex;gap:8px">
          <button class="small-btn" onclick="gotoAdminMenu()">Back</button>
        </div>
      `;
    }
    return `<div style="position:fixed;inset:0;display:flex;align-items:center;justify-content:center;z-index:80"><div style="background:white;padding:18px;border-radius:12px;max-width:720px;width:92%;box-shadow:0 12px 30px rgba(2,6,23,0.18)">${body}</div></div>`;
  }
  return '';
}

/* Restart helper */
function restartAndReset(){
  state.showForm=true; state.showFinalScore=false; state.currentMission=0; state.missionScores=[]; state.transcript=''; state.showResult=false; state.errorMessage=''; render();
}

/* utility */
function getLevelText(l){
  if(l==='beginner') return 'ğŸŒ± BEGINNER'; if(l==='intermediate') return 'ğŸŒ¿ INTERMEDIATE'; if(l==='advanced') return 'ğŸŒ³ ADVANCED'; if(l==='expert') return 'ğŸ† EXPERT'; return '';
}

/* Load saved chapter/unit */
const savedCU = localStorage.getItem('chapter_unit_settings_v1');
if(savedCU){
  try{ const d = JSON.parse(savedCU); if(d.chapter) state.currentChapter=d.chapter; if(d.unit) state.currentUnit=d.unit; }catch(e){}
}

/* Initial render */
render();
</script>
</body>
</html>
